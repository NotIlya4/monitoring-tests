default_junkfile_path := "junkfile.generated"

_default:
  just --list

_remove:
  #!python
  import os
  import shutil
  import subprocess
  from gitignore_parser import parse_gitignore
  
  path = "{{default_junkfile_path}}"
  matches = parse_gitignore(path)
  
  tobe_deleted_files = []
  tobe_deleted_dirs = []
  
  for root, dirs, files in os.walk(".", topdown=False):
      def make_full_path(root, name):
          return os.path.abspath(os.path.join(root, name))
  
      for name in files:
          full_path = make_full_path(root, name)
          if matches(full_path):
              tobe_deleted_files.append(full_path)
  
      for name in dirs:
          full_path = make_full_path(root, name)
          if matches(full_path):
              tobe_deleted_dirs.append(full_path)
  
  for full_path in tobe_deleted_dirs:
      if os.path.exists(full_path):
          shutil.rmtree(full_path)
  
  for full_path in tobe_deleted_files:
      if os.path.exists(full_path):
          os.remove(full_path)
  
  subprocess.run("just _remove-junkfile", capture_output=True)

# Removes all files generated by terraform including tfstate
remove-all:
  #!python
  import os
  import subprocess
  
  path = "{{default_junkfile_path}}"
  content = """
  .terraform*
  *.generated*
  *.tfstate*
  """
  
  with open(path, "w") as file:
    file.write(content)
    
  subprocess.run("just _remove")

# Removes files during terragrunt apply
remove-generated:
  #!python
  import os
  import subprocess
  
  path = "{{default_junkfile_path}}"
  content = """
  *.generated*
  """
  
  with open(path, "w") as file:
    file.write(content)
    
  subprocess.run("just _remove")

# Removes files generated during terraform init
remove-init:
  #!python
  import os
  import subprocess
  
  path = "{{default_junkfile_path}}"
  content = """
  .terraform*
  """
  
  with open(path, "w") as file:
    file.write(content)
    
  subprocess.run("just _remove")

_remove-junkfile:
  rm {{default_junkfile_path}}